---
- hosts: serverSql
  become: true

  vars:
    pg_version: postgresql-12.7

  tasks:
# db_name = ansibledb ; db_user = ansuser ; db_password = password
  - name: "Create app database"
    postgresql_db:
      state: present
      name: ansibledb
    become: yes
    become_user: postgres

  - name: "Create db user"
    postgresql_user:
      state: present
      name: ansuser
      password: password
    become: yes
    become_user: postgres

  - name: "Grant db user access to app db"
    postgresql_privs:
      type: database
      database: ansibledb
      roles: ansuser
      grant_option: no
      privs: all
    become: yes
    become_user: postgres

  - name: "Allow md5 connection for the db user"
    postgresql_pg_hba:
      dest: "~/data/pg_hba.conf"
      contype: host
      databases: all
      method: md5
      users: ansuser
      create: true
    become: yes
    become_user: postgres
    notify: restart postgres

  handlers:
  - name: restart postgres
    service: name=postgresql state=restarted